import os
import win32com.client  # pip install pywin32
from PySide6.QtWidgets import QFileDialog


class ExcelManager:
    def __init__(self):
        self.excel = None
        self.workbook = None
        self.sheet = None
        self.confirmed_sheet = None
        self.confirmed_cell = None

    def attach_excel(self):
        file_path, _ = QFileDialog.getOpenFileName(
            caption="Select Excel File",
            filter="Excel Files (*.xlsx *.xls)",
        )
        if not file_path:
            return False

        try:
            self.excel = win32com.client.Dispatch("Excel.Application")
            self.excel.Visible = True
            self.workbook = self.excel.Workbooks.Open(file_path)
            return True
        except Exception as e:
            print(f"[❌ Excel Error] {e}")
            return False

    def set_target(self, sheet_name, cell):
        try:
            self.sheet = self.workbook.Sheets(sheet_name)
            _ = self.sheet.Range(cell).Value  # Test access
            self.confirmed_sheet = sheet_name
            self.confirmed_cell = cell
            return True
        except Exception as e:
            print(f"[❌ Target Error] {e}")
            return False

    def is_ready(self):
        return self.sheet is not None and self.confirmed_cell is not None

    def write_to_cell(self, text):
        if not self.is_ready():
            raise Exception("Excel not ready or target not confirmed.")
        self.sheet.Range(self.confirmed_cell).Value = text
        self.workbook.Save()
        return self.workbook.Name, self.confirmed_sheet, self.confirmed_cell
